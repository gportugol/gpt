name: Build GPT Binary
on:
  workflow_call:
    inputs:
      target:
        required: true
        type: string

jobs:
  build-linux:
    if: ${{ inputs.target == 'linux' || inputs.target == 'all' }}
    runs-on: ubuntu-latest
    container:
      image: debian:trixie
    steps:
      - name: Install Build Dependencies
        run: |
          apt-get update
          apt-get install -y build-essential autoconf automake libtool \
            pkg-config antlr4 libantlr4-runtime-dev libpcre2-dev nasm git

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Build GPT Project
        run: |
          autoreconf -i
          ./configure --prefix=/usr/local
          make -j$(nproc)

      - name: Run Tests
        run: bash test/run_test.sh

      - name: Package Linux
        run: |
          make install DESTDIR=$PWD/release
          mkdir -p dist
          mv release/usr/local/* dist/

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gpt-linux
          path: dist/*

  build-windows:
    if: ${{ inputs.target == 'windows' || inputs.target == 'all' }}
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup MSYS2 Environment
        uses: msys2/setup-msys2@v2
        with:
          update: true
          msystem: MINGW64
          path-type: inherit
          install: >-
            autoconf
            automake
            libtool
            make
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-gcc-libs
            mingw-w64-x86_64-pcre2
            mingw-w64-x86_64-antlr4-runtime-cpp
            mingw-w64-x86_64-nasm
            mingw-w64-i686-gcc
            mingw-w64-i686-crt-git
            mingw-w64-i686-headers-git
            mingw-w64-i686-winpthreads-git
            pkg-config
            unzip
            wget

      - name: Cache ANTLR4 Tool
        id: cache-antlr4
        uses: actions/cache@v4
        with:
          path: D:/a/_temp/antlr4
          key: antlr4-4.13.2-tool

      - shell: msys2 {0}
        name: Setup ANTLR4 Tool
        run: |
          # Download ANTLR4 JAR if not cached
          if [ ! -f /d/a/_temp/antlr4/antlr-4.13.2-complete.jar ]; then
            mkdir -p /d/a/_temp/antlr4
            wget -O /d/a/_temp/antlr4/antlr-4.13.2-complete.jar https://www.antlr.org/download/antlr-4.13.2-complete.jar
          fi
          # Create antlr4 wrapper script using Java from setup-java (available via PATH)
          mkdir -p /usr/local/bin
          cat > /usr/local/bin/antlr4 << 'EOF'
          #!/bin/bash
          java -jar /d/a/_temp/antlr4/antlr-4.13.2-complete.jar "$@"
          EOF
          chmod +x /usr/local/bin/antlr4

      - shell: msys2 {0}
        name: Build GPT Project
        run: |
          export CXXFLAGS="-O2 -std=gnu++17 -static -static-libgcc -static-libstdc++"
          export LDFLAGS="-static -static-libgcc -static-libstdc++"
          autoreconf -i
          ./configure --prefix=/usr/local
          make -j$(nproc)
          make install

      - shell: msys2 {0}
        name: Run Tests
        run: |
          # Add 32-bit gcc to PATH for linking 32-bit binaries
          export PATH="/mingw32/bin:$PATH"
          bash test/run_test.sh

      - shell: msys2 {0}
        name: Package Windows Binary
        run: |
          make install DESTDIR=$PWD/release
          mkdir -p dist
          mv release/usr/local/* dist/
          cp /mingw64/bin/nasm.exe dist/bin/
          ldd /usr/local/bin/gpt | grep "mingw" | awk '{print $3}' | while read dll; do
              if [ -f "$dll" ]; then
                  echo "Copying $dll"
                  cp "$dll" dist/bin/
              fi
          done

      - name: Upload Windows ZIP Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gpt-windows
          path: dist/*
